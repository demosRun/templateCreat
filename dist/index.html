<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <!-- 页面的元信息 -->
    <title>测试预览页面</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=1000, user-scalable=yes"/>
    <meta name="format-detection" content="telephone=no, email=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="white"/>
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="filetype" content="1"/>
    <meta name="publishedtype" content="1"/>
    <meta name="pagetype" content="2"/>
    <meta name="description" content="{TAG_59447_TAG}"/>
    <meta name="keywords" content="{TAG_59446_TAG}"/>
    <meta name="catalogs" content="{TAG_83943_TAG}"/>
    
      <!-- 页面主样式文件 -->
      <link charset="utf-8"  rel="stylesheet" href="./static/css/owo.core.css">
      
    <!-- 附属css文件 -->
    <link rel="stylesheet" href="./static/css/main.css" charset="utf-8">
      
  </head>
  <body>
    
    <!-- 页面[page]-->
    <div class="home page" template="page" style="display: block;"><div class="panel"><div class="left"><div class="show"></div></div><div class="right"><div class="title">模块选择</div><div class="module-box"><div class="module-item" o-tap="selectModule('jianju')">间距</div><div class="module-item" o-tap="selectModule('toubu')">头部</div></div><div class="title">背景设置</div><div class="input-box"><span>背景颜色</span><div class="color-input-box"><input class="color-select" type="color" o-value="this.data.color"><input class="color-text" type="text" o-value="this.data.color"></div></div><div class="input-box"><span>背景图片</span><div class="text-input-box"><input type="text" o-value="this.data.bgUrl"></div></div><div class="title">模块设置</div><textarea id="styleEdit" value=""></textarea><div class="title">内容设置</div><textarea id="htmlEdit" value=""></textarea><div class="button-box"><div class="button" o-tap="reMake">生成</div><div class="button" o-tap="output">导出图片</div></div></div></div></div>
    

    <script src="./static/js/html2canvas.min.js" type="text/javascript"  charset="UTF-8"></script>
    <script src="./static/js/main.js" type="text/javascript"  charset="UTF-8"></script>
<!-- 框架script文件 -->
<script src="./static/js/owo.core.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript" charset="UTF-8">
owo.script = {
  "page": {
    "data": {
      "color": "#123b8b",
      "bgUrl": "./static/resource/1.jpg",
      "activeIndex1": 0,
      "activeIndex2": 0,
      "showList": [],
      "module": {
        "jianju": {
          "template": "<div [[0]]></div>",
          "styleData": [{
            "height": "40px"
          }]
        },
        "toubu": {
          "template": "<h1 [[0]]>{{0}}</h1><h2 [[1]]>{{1}}</h2>",
          "styleData": [{
            "color": "#ffcc00",
            "font-size": "44px",
            "line-height": "90px",
            "text-align": "center"
          }, {
            "color": "#ffffff",
            "font-size": "28px",
            "line-height": "50px",
            "text-align": "center"
          }],
          "edit": [{
            "type": "text",
            "value": "《学习有方》",
            "name": "顶部大标题"
          }, {
            "type": "text",
            "value": "一图领会<br>习近平高质量城市建设新思路",
            "name": "副标题"
          }]
        }
      }
    },
    "created": function created() {
      var _this = this;

      console.log(this.query('.color-select').value);
      setTimeout(function () {
        _this.make();
      }, 100);
    },
    "make": function make() {
      // 背景颜色
      var showBox = this.query('.show');
      showBox.style.backgroundColor = this.data.color;
      showBox.style.backgroundImage = "url(" + this.data.bgUrl + ")";
    },
    "output": function output() {
      var _this2 = this;

      html2canvas(this.query('.show'), {
        "allowTaint": false
      }).then(function (canvas) {
        var imgData = canvas.toDataURL('image/octet-stream');

        if (canvas.msToBlob) {
          // IE 9+浏览器
          var blob = canvas.msToBlob();
          window.navigator.msSaveBlob(blob, 'test.png');
        } else {
          _this2.saveFile(imgData, 'test.png');
        }
      });
    },
    "creatStyleStr": function creatStyleStr(ele, key) {
      ele.showHTML = ele.template;

      for (var index = 0; index < ele['styleData'].length; index++) {
        var styleData = '';
        var styleItem = ele['styleData'][index];

        for (var _key in styleItem) {
          if (styleItem.hasOwnProperty(_key)) {
            var styleValue = styleItem[_key];
            styleData += _key + ": " + styleValue + ";";
          }
        } // console.log(styleData)


        ele.showHTML = ele.showHTML.replace("[[" + index + "]]", "class=\"tem\" key=\"" + key + "\" ind=\"" + index + "\" style=\"" + styleData + "\"");
      }

      return ele;
    },
    "selectModule": function selectModule(name) {
      var item = this.data.module[name];
      this.data.showList.push(item);
      this.outPutShow();
    },
    "outPutShow": function outPutShow() {
      var _this3 = this;

      var newShowHTML = '';

      for (var index = 0; index < this.data.showList.length; index++) {
        var item = this.data.showList[index]; // 替换样式

        item = this.creatStyleStr(item, index); // console.log(item)

        var template = item['showHTML']; // 模板插值

        for (var ind in item['edit']) {
          if (item['edit'].hasOwnProperty(ind)) {
            var element = item['edit'][ind];
            template = template.replace("{{" + ind + "}}", element.value);
          }
        }

        newShowHTML += template;
      }

      this.query('.show').innerHTML = newShowHTML;
      setTimeout(function () {
        _this3.queryAll('.show .tem').forEach(function (element) {
          element.onclick = owo.script.page.changeStyle;
        });
      }, 100);
    },
    "saveFile": function saveFile(data, filename) {
      var save_link = document.createElementNS('http://www.w3.org/1999/xhtml', 'a');
      save_link.href = data;
      save_link.download = filename;
      var event = document.createEvent('MouseEvents');
      event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
      save_link.dispatchEvent(event);
    },
    "changeStyle": function changeStyle() {
      var index1 = parseInt(this.getAttribute('key'));
      var index2 = parseInt(this.getAttribute('ind'));
      owo.script.page.data.activeIndex1 = index1;
      owo.script.page.data.activeIndex2 = index2;
      var styleData = owo.script.page.data.showList[index1].styleData[index2];
      console.log(styleData);
      owo.query('#styleEdit')[0].innerText = JSON.stringify(styleData);
      owo.query('#htmlEdit')[0].innerText = JSON.stringify(owo.script.page.data.showList[index1].edit);
    },
    "reMake": function reMake() {
      var newStyleData = owo.query('#styleEdit')[0].value;
      var newHtmlData = owo.query('#htmlEdit')[0].value;
      owo.script.page.data.showList[this.data.activeIndex1].styleData[this.data.activeIndex2] = JSON.parse(newStyleData);
      owo.script.page.data.showList[this.data.activeIndex1].edit = JSON.parse(newHtmlData); // console.log(owo.script.page.data.showList)

      this.outPutShow();
    }
  }
};
</script>

  </body>
</html>